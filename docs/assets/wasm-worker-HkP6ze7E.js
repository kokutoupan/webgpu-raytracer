(function(){"use strict";let r;function C(t){const e=r.__externref_table_alloc();return r.__wbindgen_externrefs.set(e,t),e}function F(t,e){return t=t>>>0,p().subarray(t/1,t/1+e)}let w=null;function R(){return(w===null||w.buffer.detached===!0||w.buffer.detached===void 0&&w.buffer!==r.memory.buffer)&&(w=new DataView(r.memory.buffer)),w}function h(t,e){return t=t>>>0,P(t,e)}let m=null;function p(){return(m===null||m.byteLength===0)&&(m=new Uint8Array(r.memory.buffer)),m}function L(t,e){try{return t.apply(this,e)}catch(n){const _=C(n);r.__wbindgen_exn_store(_)}}function D(t){return t==null}function M(t,e){const n=e(t.length*1,1)>>>0;return p().set(t,n/1),f=t.length,n}function x(t,e,n){if(n===void 0){const a=y.encode(t),l=e(a.length,1)>>>0;return p().subarray(l,l+a.length).set(a),f=a.length,l}let _=t.length,i=e(_,1)>>>0;const u=p();let o=0;for(;o<_;o++){const a=t.charCodeAt(o);if(a>127)break;u[i+o]=a}if(o!==_){o!==0&&(t=t.slice(o)),i=n(i,_,_=o+t.length*3,1)>>>0;const a=p().subarray(i+o,i+_),l=y.encodeInto(t,a);o+=l.written,i=n(i,_,o,1)>>>0}return f=o,i}let A=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});A.decode();const N=2146435072;let T=0;function P(t,e){return T+=e,T>=N&&(A=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),A.decode(),T=e),A.decode(p().subarray(t,t+e))}const y=new TextEncoder;"encodeInto"in y||(y.encodeInto=function(t,e){const n=y.encode(t);return e.set(n),{read:t.length,written:n.length}});let f=0;typeof FinalizationRegistry>"u"||new FinalizationRegistry(t=>r.__wbg_renderbuffers_free(t>>>0,1));const W=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>r.__wbg_world_free(t>>>0,1));class S{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,W.unregister(this),e}free(){const e=this.__destroy_into_raw();r.__wbg_world_free(e,0)}camera_ptr(){return r.world_camera_ptr(this.__wbg_ptr)>>>0}indices_len(){return r.world_indices_len(this.__wbg_ptr)>>>0}indices_ptr(){return r.world_indices_ptr(this.__wbg_ptr)>>>0}normals_len(){return r.world_normals_len(this.__wbg_ptr)>>>0}normals_ptr(){return r.world_normals_ptr(this.__wbg_ptr)>>>0}vertices_len(){return r.world_vertices_len(this.__wbg_ptr)>>>0}vertices_ptr(){return r.world_vertices_ptr(this.__wbg_ptr)>>>0}instances_len(){return r.world_instances_len(this.__wbg_ptr)>>>0}instances_ptr(){return r.world_instances_ptr(this.__wbg_ptr)>>>0}set_animation(e){r.world_set_animation(this.__wbg_ptr,e)}update_camera(e,n){r.world_update_camera(this.__wbg_ptr,e,n)}attributes_len(){return r.world_attributes_len(this.__wbg_ptr)>>>0}attributes_ptr(){return r.world_attributes_ptr(this.__wbg_ptr)>>>0}get_texture_ptr(e){return r.world_get_texture_ptr(this.__wbg_ptr,e)>>>0}get_texture_size(e){return r.world_get_texture_size(this.__wbg_ptr,e)>>>0}get_texture_count(){return r.world_get_texture_count(this.__wbg_ptr)>>>0}get_animation_name(e){let n,_;try{const i=r.world_get_animation_name(this.__wbg_ptr,e);return n=i[0],_=i[1],h(i[0],i[1])}finally{r.__wbindgen_free(n,_,1)}}load_animation_glb(e){const n=M(e,r.__wbindgen_malloc),_=f;r.world_load_animation_glb(this.__wbg_ptr,n,_)}get_animation_count(){return r.world_get_animation_count(this.__wbg_ptr)>>>0}constructor(e,n,_){const i=x(e,r.__wbindgen_malloc,r.__wbindgen_realloc),u=f;var o=D(n)?0:x(n,r.__wbindgen_malloc,r.__wbindgen_realloc),a=f,l=D(_)?0:M(_,r.__wbindgen_malloc),b=f;const g=r.world_new(i,u,o,a,l,b);return this.__wbg_ptr=g>>>0,W.register(this,this.__wbg_ptr,this),this}update(e){r.world_update(this.__wbg_ptr,e)}uvs_len(){return r.world_uvs_len(this.__wbg_ptr)>>>0}uvs_ptr(){return r.world_uvs_ptr(this.__wbg_ptr)>>>0}blas_len(){return r.world_blas_len(this.__wbg_ptr)>>>0}blas_ptr(){return r.world_blas_ptr(this.__wbg_ptr)>>>0}tlas_len(){return r.world_tlas_len(this.__wbg_ptr)>>>0}tlas_ptr(){return r.world_tlas_ptr(this.__wbg_ptr)>>>0}}Symbol.dispose&&(S.prototype[Symbol.dispose]=S.prototype.free);const V=new Set(["basic","cors","default"]);async function B(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(_){if(t.ok&&V.has(t.type)&&t.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",_);else throw _}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}function j(){const t={};return t.wbg={},t.wbg.__wbg___wbindgen_throw_dd24417ed36fc46e=function(e,n){throw new Error(h(e,n))},t.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,n){let _,i;try{_=e,i=n,console.error(h(e,n))}finally{r.__wbindgen_free(_,i,1)}},t.wbg.__wbg_getRandomValues_1c61fac11405ffdc=function(){return L(function(e,n){globalThis.crypto.getRandomValues(F(e,n))},arguments)},t.wbg.__wbg_log_1d990106d99dacb7=function(e){console.log(e)},t.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},t.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,n){const _=n.stack,i=x(_,r.__wbindgen_malloc,r.__wbindgen_realloc),u=f;R().setInt32(e+4,u,!0),R().setInt32(e+0,i,!0)},t.wbg.__wbindgen_cast_2241b6af4c4b2941=function(e,n){return h(e,n)},t.wbg.__wbindgen_init_externref_table=function(){const e=r.__wbindgen_externrefs,n=e.grow(4);e.set(0,void 0),e.set(n+0,void 0),e.set(n+1,null),e.set(n+2,!0),e.set(n+3,!1)},t}function Y(t,e){return r=t.exports,k.__wbindgen_wasm_module=e,w=null,m=null,r.__wbindgen_start(),r}async function k(t){if(r!==void 0)return r;typeof t<"u"&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof t>"u"&&(t=new URL("/webgpu-raytracer/assets/rust_shader_tools_bg-CC5HVMsp.wasm",self.location.href));const e=j();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:_}=await B(await t,e);return Y(n,_)}let s=null,E=null;const c=(t,e)=>new Float32Array(E.buffer,t,e).slice(),I=(t,e)=>new Uint32Array(E.buffer,t,e).slice(),q=()=>{if(!s)return;const t=c(s.vertices_ptr(),s.vertices_len()),e=c(s.normals_ptr(),s.normals_len()),n=c(s.uvs_ptr(),s.uvs_len()),_=I(s.indices_ptr(),s.indices_len()),i=c(s.attributes_ptr(),s.attributes_len()),u=c(s.tlas_ptr(),s.tlas_len()),o=c(s.blas_ptr(),s.blas_len()),a=c(s.instances_ptr(),s.instances_len()),l=c(s.camera_ptr(),24),b=s.get_texture_count(),g=[],v=[];for(let d=0;d<b;d++){const $=s.get_texture_ptr(d),G=s.get_texture_size(d),z=new Uint8Array(E.buffer,$,G).slice();g.push(z),v.push(z.buffer)}const X=s.get_animation_count(),O=[];for(let d=0;d<X;d++)O.push(s.get_animation_name(d));const H={type:"SCENE_LOADED",vertices:t,normals:e,uvs:n,indices:_,attributes:i,tlas:u,blas:o,instances:a,camera:l,textureCount:b,textures:g,animations:O};self.postMessage(H,[t.buffer,e.buffer,n.buffer,_.buffer,i.buffer,u.buffer,o.buffer,a.buffer,l.buffer,...v])},U=(t=!0)=>{if(!s)return;const e=c(s.tlas_ptr(),s.tlas_len()),n=c(s.blas_ptr(),s.blas_len()),_=c(s.instances_ptr(),s.instances_len()),i=c(s.camera_ptr(),24);let u,o,a,l,b;const g=[e.buffer,n.buffer,_.buffer,i.buffer];t&&(u=c(s.vertices_ptr(),s.vertices_len()),o=c(s.normals_ptr(),s.normals_len()),a=c(s.uvs_ptr(),s.uvs_len()),l=I(s.indices_ptr(),s.indices_len()),b=c(s.attributes_ptr(),s.attributes_len()),g.push(u.buffer,o.buffer,a.buffer,l.buffer,b.buffer));const v={type:"UPDATE_RESULT",tlas:e,blas:n,instances:_,camera:i,vertices:u,normals:o,uvs:a,indices:l,attributes:b};self.postMessage(v,g)};self.onmessage=async t=>{const e=t.data;switch(e.type){case"INIT":E=(await k()).memory,console.log("Worker: WASM Initialized"),self.postMessage({type:"READY"});break;case"LOAD_SCENE":s&&s.free(),console.log(`Worker: Loading Scene ${e.sceneName}`),s=new S(e.sceneName,e.objSource,e.glbData),s.update(0),console.log("Worker: Scene Loaded, sending data..."),q();break;case"UPDATE":s&&(s.update(e.time),U());break;case"UPDATE_CAMERA":s&&(s.update_camera(e.width,e.height),U(!1));break;case"SET_ANIMATION":s?.set_animation(e.index);break;case"LOAD_ANIMATION":s?.load_animation_glb(e.data);break}}})();
