(function(){"use strict";let r;function F(t){const e=r.__externref_table_alloc();return r.__wbindgen_externrefs.set(e,t),e}function L(t,e){return t=t>>>0,p().subarray(t/1,t/1+e)}let w=null;function D(){return(w===null||w.buffer.detached===!0||w.buffer.detached===void 0&&w.buffer!==r.memory.buffer)&&(w=new DataView(r.memory.buffer)),w}function y(t,e){return t=t>>>0,P(t,e)}let m=null;function p(){return(m===null||m.byteLength===0)&&(m=new Uint8Array(r.memory.buffer)),m}function N(t,e){try{return t.apply(this,e)}catch(n){const _=F(n);r.__wbindgen_exn_store(_)}}function W(t){return t==null}function M(t,e){const n=e(t.length*1,1)>>>0;return p().set(t,n/1),u=t.length,n}function T(t,e,n){if(n===void 0){const a=h.encode(t),l=e(a.length,1)>>>0;return p().subarray(l,l+a.length).set(a),u=a.length,l}let _=t.length,o=e(_,1)>>>0;const f=p();let i=0;for(;i<_;i++){const a=t.charCodeAt(i);if(a>127)break;f[o+i]=a}if(i!==_){i!==0&&(t=t.slice(i)),o=n(o,_,_=i+t.length*3,1)>>>0;const a=p().subarray(o+i,o+_),l=h.encodeInto(t,a);i+=l.written,o=n(o,_,i,1)>>>0}return u=i,o}let A=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});A.decode();const C=2146435072;let R=0;function P(t,e){return R+=e,R>=C&&(A=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),A.decode(),R=e),A.decode(p().subarray(t,t+e))}const h=new TextEncoder;"encodeInto"in h||(h.encodeInto=function(t,e){const n=h.encode(t);return e.set(n),{read:t.length,written:n.length}});let u=0;typeof FinalizationRegistry>"u"||new FinalizationRegistry(t=>r.__wbg_renderbuffers_free(t>>>0,1));const k=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>r.__wbg_world_free(t>>>0,1));class S{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,k.unregister(this),e}free(){const e=this.__destroy_into_raw();r.__wbg_world_free(e,0)}camera_ptr(){return r.world_camera_ptr(this.__wbg_ptr)>>>0}lights_len(){return r.world_lights_len(this.__wbg_ptr)>>>0}lights_ptr(){return r.world_lights_ptr(this.__wbg_ptr)>>>0}normals_len(){return r.world_normals_len(this.__wbg_ptr)>>>0}normals_ptr(){return r.world_normals_ptr(this.__wbg_ptr)>>>0}vertices_len(){return r.world_vertices_len(this.__wbg_ptr)>>>0}vertices_ptr(){return r.world_vertices_ptr(this.__wbg_ptr)>>>0}instances_len(){return r.world_instances_len(this.__wbg_ptr)>>>0}instances_ptr(){return r.world_instances_ptr(this.__wbg_ptr)>>>0}set_animation(e){r.world_set_animation(this.__wbg_ptr,e)}update_camera(e,n){r.world_update_camera(this.__wbg_ptr,e,n)}get_texture_ptr(e){return r.world_get_texture_ptr(this.__wbg_ptr,e)>>>0}get_texture_size(e){return r.world_get_texture_size(this.__wbg_ptr,e)>>>0}get_texture_count(){return r.world_get_texture_count(this.__wbg_ptr)>>>0}mesh_topology_len(){return r.world_mesh_topology_len(this.__wbg_ptr)>>>0}mesh_topology_ptr(){return r.world_mesh_topology_ptr(this.__wbg_ptr)>>>0}get_animation_name(e){let n,_;try{const o=r.world_get_animation_name(this.__wbg_ptr,e);return n=o[0],_=o[1],y(o[0],o[1])}finally{r.__wbindgen_free(n,_,1)}}load_animation_glb(e){const n=M(e,r.__wbindgen_malloc),_=u;r.world_load_animation_glb(this.__wbg_ptr,n,_)}get_animation_count(){return r.world_get_animation_count(this.__wbg_ptr)>>>0}constructor(e,n,_){const o=T(e,r.__wbindgen_malloc,r.__wbindgen_realloc),f=u;var i=W(n)?0:T(n,r.__wbindgen_malloc,r.__wbindgen_realloc),a=u,l=W(_)?0:M(_,r.__wbindgen_malloc),b=u;const d=r.world_new(o,f,i,a,l,b);return this.__wbg_ptr=d>>>0,k.register(this,this.__wbg_ptr,this),this}update(e){r.world_update(this.__wbg_ptr,e)}uvs_len(){return r.world_uvs_len(this.__wbg_ptr)>>>0}uvs_ptr(){return r.world_uvs_ptr(this.__wbg_ptr)>>>0}blas_len(){return r.world_blas_len(this.__wbg_ptr)>>>0}blas_ptr(){return r.world_blas_ptr(this.__wbg_ptr)>>>0}tlas_len(){return r.world_tlas_len(this.__wbg_ptr)>>>0}tlas_ptr(){return r.world_tlas_ptr(this.__wbg_ptr)>>>0}}Symbol.dispose&&(S.prototype[Symbol.dispose]=S.prototype.free);const V=new Set(["basic","cors","default"]);async function B(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(_){if(t.ok&&V.has(t.type)&&t.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",_);else throw _}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}function j(){const t={};return t.wbg={},t.wbg.__wbg___wbindgen_throw_dd24417ed36fc46e=function(e,n){throw new Error(y(e,n))},t.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,n){let _,o;try{_=e,o=n,console.error(y(e,n))}finally{r.__wbindgen_free(_,o,1)}},t.wbg.__wbg_getRandomValues_1c61fac11405ffdc=function(){return N(function(e,n){globalThis.crypto.getRandomValues(L(e,n))},arguments)},t.wbg.__wbg_log_1d990106d99dacb7=function(e){console.log(e)},t.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},t.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,n){const _=n.stack,o=T(_,r.__wbindgen_malloc,r.__wbindgen_realloc),f=u;D().setInt32(e+4,f,!0),D().setInt32(e+0,o,!0)},t.wbg.__wbindgen_cast_2241b6af4c4b2941=function(e,n){return y(e,n)},t.wbg.__wbindgen_init_externref_table=function(){const e=r.__wbindgen_externrefs,n=e.grow(4);e.set(0,void 0),e.set(n+0,void 0),e.set(n+1,null),e.set(n+2,!0),e.set(n+3,!1)},t}function Y(t,e){return r=t.exports,I.__wbindgen_wasm_module=e,w=null,m=null,r.__wbindgen_start(),r}async function I(t){if(r!==void 0)return r;typeof t<"u"&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof t>"u"&&(t=new URL("/webgpu-raytracer/assets/rust_shader_tools_bg-C8RwaASR.wasm",self.location.href));const e=j();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:_}=await B(await t,e);return Y(n,_)}let s=null,E=null;const c=(t,e)=>new Float32Array(E.buffer,t,e).slice(),v=(t,e)=>new Uint32Array(E.buffer,t,e).slice(),q=()=>{if(!s)return;const t=c(s.vertices_ptr(),s.vertices_len()),e=c(s.normals_ptr(),s.normals_len()),n=c(s.uvs_ptr(),s.uvs_len()),_=v(s.mesh_topology_ptr(),s.mesh_topology_len()),o=v(s.lights_ptr(),s.lights_len()),f=c(s.tlas_ptr(),s.tlas_len()),i=c(s.blas_ptr(),s.blas_len()),a=c(s.instances_ptr(),s.instances_len()),l=c(s.camera_ptr(),24),b=s.get_texture_count(),d=[],x=[];for(let g=0;g<b;g++){const G=s.get_texture_ptr(g),H=s.get_texture_size(g),z=new Uint8Array(E.buffer,G,H).slice();d.push(z),x.push(z.buffer)}const X=s.get_animation_count(),O=[];for(let g=0;g<X;g++)O.push(s.get_animation_name(g));const $={type:"SCENE_LOADED",vertices:t,normals:e,uvs:n,mesh_topology:_,lights:o,tlas:f,blas:i,instances:a,camera:l,textureCount:b,textures:d,animations:O};self.postMessage($,[t.buffer,e.buffer,n.buffer,_.buffer,o.buffer,f.buffer,i.buffer,a.buffer,l.buffer,...x])},U=(t=!0)=>{if(!s)return;const e=c(s.tlas_ptr(),s.tlas_len()),n=c(s.blas_ptr(),s.blas_len()),_=c(s.instances_ptr(),s.instances_len()),o=v(s.lights_ptr(),s.lights_len()),f=c(s.camera_ptr(),24);let i,a,l,b;const d=[e.buffer,n.buffer,_.buffer,f.buffer];t&&(i=c(s.vertices_ptr(),s.vertices_len()),a=c(s.normals_ptr(),s.normals_len()),l=c(s.uvs_ptr(),s.uvs_len()),b=v(s.mesh_topology_ptr(),s.mesh_topology_len()),d.push(i.buffer,a.buffer,l.buffer,b.buffer));const x={type:"UPDATE_RESULT",tlas:e,blas:n,instances:_,lights:o,camera:f,vertices:i,normals:a,uvs:l,mesh_topology:b};self.postMessage(x,d)};self.onmessage=async t=>{const e=t.data;switch(e.type){case"INIT":E=(await I()).memory,console.log("Worker: WASM Initialized"),self.postMessage({type:"READY"});break;case"LOAD_SCENE":s&&s.free(),console.log(`Worker: Loading Scene ${e.sceneName}`),s=new S(e.sceneName,e.objSource,e.glbData),s.update(0),console.log("Worker: Scene Loaded, sending data..."),q();break;case"UPDATE":s&&(s.update(e.time),U());break;case"UPDATE_CAMERA":s&&(s.update_camera(e.width,e.height),U(!1));break;case"SET_ANIMATION":s?.set_animation(e.index);break;case"LOAD_ANIMATION":s?.load_animation_glb(e.data);break}}})();
