(function(){"use strict";let n;function F(e){const t=n.__externref_table_alloc();return n.__wbindgen_externrefs.set(t,e),t}function o(e){if(typeof e!="number")throw new Error(`expected a number argument, found ${typeof e}`)}function L(e,t){return e=e>>>0,d().subarray(e/1,e/1+t)}let p=null;function D(){return(p===null||p.buffer.detached===!0||p.buffer.detached===void 0&&p.buffer!==n.memory.buffer)&&(p=new DataView(n.memory.buffer)),p}function E(e,t){return e=e>>>0,V(e,t)}let m=null;function d(){return(m===null||m.byteLength===0)&&(m=new Uint8Array(n.memory.buffer)),m}function C(e,t){try{return e.apply(this,t)}catch(r){const _=F(r);n.__wbindgen_exn_store(_)}}function W(e){return e==null}function y(e,t){try{return e.apply(this,t)}catch(r){let _=(function(){try{return r instanceof Error?`${r.message}

Stack:
${r.stack}`:r.toString()}catch{return"<failed to stringify thrown value>"}})();throw console.error("wasm-bindgen: imported JS function that was not marked as `catch` threw an error:",_),r}}function k(e,t){const r=t(e.length*1,1)>>>0;return d().set(e,r/1),f=e.length,r}function S(e,t,r){if(typeof e!="string")throw new Error(`expected a string argument, found ${typeof e}`);if(r===void 0){const c=v.encode(e),u=t(c.length,1)>>>0;return d().subarray(u,u+c.length).set(c),f=c.length,u}let _=e.length,i=t(_,1)>>>0;const w=d();let a=0;for(;a<_;a++){const c=e.charCodeAt(a);if(c>127)break;w[i+a]=c}if(a!==_){a!==0&&(e=e.slice(a)),i=r(i,_,_=a+e.length*3,1)>>>0;const c=d().subarray(i+a,i+_),u=v.encodeInto(e,c);if(u.read!==e.length)throw new Error("failed to pass whole string");a+=u.written,i=r(i,_,a,1)>>>0}return f=a,i}let A=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});A.decode();const P=2146435072;let T=0;function V(e,t){return T+=t,T>=P&&(A=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),A.decode(),T=t),A.decode(d().subarray(e,e+t))}const v=new TextEncoder;"encodeInto"in v||(v.encodeInto=function(e,t){const r=v.encode(e);return t.set(r),{read:e.length,written:r.length}});let f=0;typeof FinalizationRegistry>"u"||new FinalizationRegistry(e=>n.__wbg_renderbuffers_free(e>>>0,1));const M=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>n.__wbg_world_free(e>>>0,1));class R{__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,M.unregister(this),t}free(){const t=this.__destroy_into_raw();n.__wbg_world_free(t,0)}camera_ptr(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_camera_ptr(this.__wbg_ptr)>>>0}normals_len(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_normals_len(this.__wbg_ptr)>>>0}normals_ptr(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_normals_ptr(this.__wbg_ptr)>>>0}vertices_len(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_vertices_len(this.__wbg_ptr)>>>0}vertices_ptr(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_vertices_ptr(this.__wbg_ptr)>>>0}instances_len(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_instances_len(this.__wbg_ptr)>>>0}instances_ptr(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_instances_ptr(this.__wbg_ptr)>>>0}set_animation(t){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");o(this.__wbg_ptr),o(t),n.world_set_animation(this.__wbg_ptr,t)}update_camera(t,r){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");o(this.__wbg_ptr),n.world_update_camera(this.__wbg_ptr,t,r)}get_texture_ptr(t){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),o(t),n.world_get_texture_ptr(this.__wbg_ptr,t)>>>0}get_texture_size(t){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),o(t),n.world_get_texture_size(this.__wbg_ptr,t)>>>0}get_texture_count(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_get_texture_count(this.__wbg_ptr)>>>0}mesh_topology_len(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_mesh_topology_len(this.__wbg_ptr)>>>0}mesh_topology_ptr(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_mesh_topology_ptr(this.__wbg_ptr)>>>0}get_animation_name(t){let r,_;try{if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");o(this.__wbg_ptr),o(t);const i=n.world_get_animation_name(this.__wbg_ptr,t);return r=i[0],_=i[1],E(i[0],i[1])}finally{n.__wbindgen_free(r,_,1)}}load_animation_glb(t){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");o(this.__wbg_ptr);const r=k(t,n.__wbindgen_malloc),_=f;n.world_load_animation_glb(this.__wbg_ptr,r,_)}get_animation_count(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_get_animation_count(this.__wbg_ptr)>>>0}constructor(t,r,_){const i=S(t,n.__wbindgen_malloc,n.__wbindgen_realloc),w=f;var a=W(r)?0:S(r,n.__wbindgen_malloc,n.__wbindgen_realloc),c=f,u=W(_)?0:k(_,n.__wbindgen_malloc),g=f;const h=n.world_new(i,w,a,c,u,g);return this.__wbg_ptr=h>>>0,M.register(this,this.__wbg_ptr,this),this}update(t){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");o(this.__wbg_ptr),n.world_update(this.__wbg_ptr,t)}uvs_len(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_uvs_len(this.__wbg_ptr)>>>0}uvs_ptr(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_uvs_ptr(this.__wbg_ptr)>>>0}blas_len(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_blas_len(this.__wbg_ptr)>>>0}blas_ptr(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_blas_ptr(this.__wbg_ptr)>>>0}tlas_len(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_tlas_len(this.__wbg_ptr)>>>0}tlas_ptr(){if(this.__wbg_ptr==0)throw new Error("Attempt to use a moved value");return o(this.__wbg_ptr),n.world_tlas_ptr(this.__wbg_ptr)>>>0}}Symbol.dispose&&(R.prototype[Symbol.dispose]=R.prototype.free);const B=new Set(["basic","cors","default"]);async function $(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(_){if(e.ok&&B.has(e.type)&&e.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",_);else throw _}const r=await e.arrayBuffer();return await WebAssembly.instantiate(r,t)}else{const r=await WebAssembly.instantiate(e,t);return r instanceof WebAssembly.Instance?{instance:r,module:e}:r}}function j(){const e={};return e.wbg={},e.wbg.__wbg___wbindgen_throw_dd24417ed36fc46e=function(t,r){throw new Error(E(t,r))},e.wbg.__wbg_error_7534b8e9a36f1ab4=function(){return y(function(t,r){let _,i;try{_=t,i=r,console.error(E(t,r))}finally{n.__wbindgen_free(_,i,1)}},arguments)},e.wbg.__wbg_getRandomValues_1c61fac11405ffdc=function(){return C(function(t,r){globalThis.crypto.getRandomValues(L(t,r))},arguments)},e.wbg.__wbg_log_1d990106d99dacb7=function(){return y(function(t){console.log(t)},arguments)},e.wbg.__wbg_new_8a6f238a6ece86ea=function(){return y(function(){return new Error},arguments)},e.wbg.__wbg_stack_0ed75d68575b0f3c=function(){return y(function(t,r){const _=r.stack,i=S(_,n.__wbindgen_malloc,n.__wbindgen_realloc),w=f;D().setInt32(t+4,w,!0),D().setInt32(t+0,i,!0)},arguments)},e.wbg.__wbindgen_cast_2241b6af4c4b2941=function(){return y(function(t,r){return E(t,r)},arguments)},e.wbg.__wbindgen_init_externref_table=function(){const t=n.__wbindgen_externrefs,r=t.grow(4);t.set(0,void 0),t.set(r+0,void 0),t.set(r+1,null),t.set(r+2,!0),t.set(r+3,!1)},e}function Y(e,t){return n=e.exports,I.__wbindgen_wasm_module=t,p=null,m=null,n.__wbindgen_start(),n}async function I(e){if(n!==void 0)return n;typeof e<"u"&&(Object.getPrototypeOf(e)===Object.prototype?{module_or_path:e}=e:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof e>"u"&&(e=new URL("/webgpu-raytracer/assets/rust_shader_tools_bg-Cc8869c6.wasm",self.location.href));const t=j();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:r,module:_}=await $(await e,t);return Y(r,_)}let s=null,x=null;const l=(e,t)=>new Float32Array(x.buffer,e,t).slice(),U=(e,t)=>new Uint32Array(x.buffer,e,t).slice(),q=()=>{if(!s)return;const e=l(s.vertices_ptr(),s.vertices_len()),t=l(s.normals_ptr(),s.normals_len()),r=l(s.uvs_ptr(),s.uvs_len()),_=U(s.mesh_topology_ptr(),s.mesh_topology_len()),i=l(s.tlas_ptr(),s.tlas_len()),w=l(s.blas_ptr(),s.blas_len()),a=l(s.instances_ptr(),s.instances_len()),c=l(s.camera_ptr(),24),u=s.get_texture_count(),g=[],h=[];for(let b=0;b<u;b++){const G=s.get_texture_ptr(b),H=s.get_texture_size(b),z=new Uint8Array(x.buffer,G,H).slice();g.push(z),h.push(z.buffer)}const X=s.get_animation_count(),N=[];for(let b=0;b<X;b++)N.push(s.get_animation_name(b));const J={type:"SCENE_LOADED",vertices:e,normals:t,uvs:r,mesh_topology:_,tlas:i,blas:w,instances:a,camera:c,textureCount:u,textures:g,animations:N};self.postMessage(J,[e.buffer,t.buffer,r.buffer,_.buffer,i.buffer,w.buffer,a.buffer,c.buffer,...h])},O=(e=!0)=>{if(!s)return;const t=l(s.tlas_ptr(),s.tlas_len()),r=l(s.blas_ptr(),s.blas_len()),_=l(s.instances_ptr(),s.instances_len()),i=l(s.camera_ptr(),24);let w,a,c,u;const g=[t.buffer,r.buffer,_.buffer,i.buffer];e&&(w=l(s.vertices_ptr(),s.vertices_len()),a=l(s.normals_ptr(),s.normals_len()),c=l(s.uvs_ptr(),s.uvs_len()),u=U(s.mesh_topology_ptr(),s.mesh_topology_len()),g.push(w.buffer,a.buffer,c.buffer,u.buffer));const h={type:"UPDATE_RESULT",tlas:t,blas:r,instances:_,camera:i,vertices:w,normals:a,uvs:c,mesh_topology:u};self.postMessage(h,g)};self.onmessage=async e=>{const t=e.data;switch(t.type){case"INIT":x=(await I()).memory,console.log("Worker: WASM Initialized"),self.postMessage({type:"READY"});break;case"LOAD_SCENE":s&&s.free(),console.log(`Worker: Loading Scene ${t.sceneName}`),s=new R(t.sceneName,t.objSource,t.glbData),s.update(0),console.log("Worker: Scene Loaded, sending data..."),q();break;case"UPDATE":s&&(s.update(t.time),O());break;case"UPDATE_CAMERA":s&&(s.update_camera(t.width,t.height),O(!1));break;case"SET_ANIMATION":s?.set_animation(t.index);break;case"LOAD_ANIMATION":s?.load_animation_glb(t.data);break}}})();
